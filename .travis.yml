language: node_js
node_js:
  - "11"

services:
  - docker

install:
  - curl -sL https://ibm.biz/idt-installer | bash

script:
#docker push us.icr.io/dalehille/webapp:0.0.1
  - docker build --rm -t "us.icr.io/dalehille/webapp:${TRAVIS_COMMIT}" .
  - if [ -n "${TRAVIS_TAG}" ]; then docker tag us.icr.io/dalehille/webapp:${TRAVIS_COMMIT} us.icr.io/dalehille/webapp:${TRAVIS_TAG}; fi
  - docker images
  - ./build/process-template.sh kubernetes/webapp/resource.yaml >/tmp/resource.yaml

before_deploy:
  - ibmcloud login -r us-south --apikey ${IBMCLOUD_API_KEY}
  - ibmcloud cr region-set us-south
  - ibmcloud cr login
  # - docker login -u="${QUAY_ID}" -p="${QUAY_TOKEN}" us.icr.io

after_success:
- curl --request POST
       --url ${RAZEE_API}/api/v1/channels/${RAZEE_CHANNEL}/version
       --header 'content-type: text/yaml'
       --header 'razee-org-key: ${RAZEE_ORG_KEY}'
       --header 'resource-description: ${TRAVIS_COMMIT_MESSAGE}'
       --header 'resource-name: ${TRAVIS_TAG}'
       --header 'x-api-key: ${X_API_KEY}'
       --header 'x-user-id: ${X_USER_ID}'
       --data @/tmp/resource.yaml

deploy:
  # Deploy alpha builds
  - provider: script
    script: docker push "us.icr.io/dalehille/webapp:${TRAVIS_TAG}"
    skip_cleanup: true
    on:
      tags: true
      condition: ${TRAVIS_TAG} =~ ^[0-9]+\.[0-9]+\.[0-9]+_[0-9]{3}$
  - provider: releases
    file: /tmp/resource.yaml
    skip_cleanup: true
    draft: true
    on:
      tags: true
      condition: ${TRAVIS_TAG} =~ ^[0-9]+\.[0-9]+\.[0-9]+_[0-9]{3}$
    api_key:
      secure: "${GITHUB_TOKEN}"

  # Deploy released builds
  - provider: script
    script: docker push "us.icr.io/dalehille/webapp:${TRAVIS_TAG}"
    skip_cleanup: true
    on:
      tags: true
      condition: ${TRAVIS_TAG} =~ ^[0-9]+\.[0-9]+\.[0-9]+$
  - provider: releases
    file: /tmp/resource.yaml
    skip_cleanup: true
    on:
      tags: true
      condition: ${TRAVIS_TAG} =~ ^[0-9]+\.[0-9]+\.[0-9]+$
    api_key:
      secure: "${GITHUB_TOKEN}"
